name: SPD Pipeline

on:
  # RFP Radar ì™„ë£Œ ì‹œ ìë™ íŠ¸ë¦¬ê±°
  workflow_run:
    workflows: ["RFP Radar Daily"]
    types: [completed]
    branches: [main]
  
  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      min_grade:
        description: 'ìµœì†Œ ë“±ê¸‰ í•„í„° (S, A, B)'
        required: false
        default: 'A'
      specific_bid:
        description: 'íŠ¹ì • ê³µê³ ë²ˆí˜¸ (ë¹ˆì¹¸=ì „ì²´)'
        required: false
        default: ''
      dry_run:
        description: 'DRY-RUN (GPT ë¯¸í˜¸ì¶œ)'
        required: false
        default: 'false'
        type: boolean

jobs:
  spd-analysis:
    runs-on: ubuntu-latest
    # RFP Radar ì„±ê³µ ì‹œì—ë§Œ ì‹¤í–‰ (ìˆ˜ë™ íŠ¸ë¦¬ê±°ëŠ” í•­ìƒ)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v4
      
      # 2. Python ì„¤ì •
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # 3. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: |
          pip install -r spd/requirements.txt
          # HWP ë³€í™˜ìš© LibreOffice
          sudo apt-get update && sudo apt-get install -y libreoffice-core libreoffice-writer
      
      # 4. RFP Radar ê²°ê³¼ ê°€ì ¸ì˜¤ê¸° (ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì‹œ)
      - name: Download RFP Radar results
        if: ${{ github.event_name == 'workflow_run' }}
        uses: actions/download-artifact@v4
        with:
          name: rfp-results-${{ github.event.workflow_run.id }}
          path: rfp_radar/data/daily_reports/
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      
      # 5. ì¶œë ¥ ë””ë ‰í† ë¦¬ ìƒì„±
      - name: Create output directories
        run: |
          mkdir -p spd/data/downloads
          mkdir -p spd/data/extracted
          mkdir -p spd/data/fetch_results
          mkdir -p spd/data/analysis_results
      
      # 6. Phase 1-A: Auto-Fetch
      - name: Run Auto-Fetch
        env:
          RFP_SERVICE_KEY: ${{ secrets.RFP_SERVICE_KEY }}
        working-directory: spd
        run: |
          GRADE="${{ github.event.inputs.min_grade || 'B' }}"
          BID="${{ github.event.inputs.specific_bid || '' }}"
          
          CMD="python spd_auto_fetch.py --grade $GRADE"
          if [ -n "$BID" ]; then CMD="$CMD --bid $BID"; fi
          
          echo "ğŸš€ Auto-Fetch: $CMD"
          eval $CMD
      
      # 7. Phase 1-B: Analysis
      - name: Run Analysis Engine
        env:
          RFP_OPENAI_API_KEY: ${{ secrets.RFP_OPENAI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.RFP_OPENAI_API_KEY }}
        working-directory: spd
        run: |
          DRY="${{ github.event.inputs.dry_run || 'false' }}"
          BID="${{ github.event.inputs.specific_bid || '' }}"
          
          CMD="python spd_analysis_engine.py"
          if [ "$DRY" = "true" ]; then CMD="$CMD --dry-run"; fi
          if [ -n "$BID" ]; then CMD="$CMD --bid $BID"; fi
          
          echo "ğŸ”¬ Analysis: $CMD"
          eval $CMD
      
      # 8. Node.js ì„¤ì • (DOCX ìƒì„±ìš©)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      # 9. DOCX ë¦¬í¬íŠ¸ ìƒì„± + ì´ë©”ì¼ ë°œì†¡ (í†µí•©)
      - name: Generate Report & Send Email
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          SPD_SMTP_SERVER: smtp.gmail.com
          SPD_SENDER_EMAIL: ${{ secrets.RFP_SENDER_EMAIL }}
          SPD_SENDER_PASSWORD: ${{ secrets.RFP_SENDER_PASSWORD }}
          SPD_RECIPIENTS: ${{ secrets.RFP_RECIPIENT_EMAILS }}
        working-directory: spd
        run: |
          npm install docx
          python spd_report.py --latest --email
          echo "ğŸ“„ DOCX ìƒì„± + ğŸ“§ ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ"
        continue-on-error: true
      
      # 9b. DRY-RUN ì‹œ í†µê³„ë§Œ ì¶œë ¥
      - name: Stats Only (dry-run)
        if: ${{ github.event.inputs.dry_run == 'true' }}
        working-directory: spd
        run: |
          npm install docx
          python spd_report.py --latest --stats-only
          echo "ğŸ“„ DRY-RUN í†µê³„ ì¶œë ¥ ì™„ë£Œ"
      
      # 11. ê²°ê³¼ ì•„ì¹´ì´ë¸Œ
      - name: Archive SPD results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: spd-results-${{ github.run_id }}
          path: |
            spd/data/fetch_results/
            spd/data/analysis_results/
            spd/data/reports/
          retention-days: 14
